<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>signal/elements</title>
    <script type="importmap">
      {
        "imports": {
          "signal": "https://cdn.jsdelivr.net/gh/mini-jail/signal/mod.js"
        }
      }
    </script>
    <script type="module">
      import {
        createSignal,
        createScope,
        createEffect,
        onCleanup,
        onMount,
      } from "signal";

      /**
       * @template T
       * @typedef {(this: T, props: Props) => void} Modify<T>
       */

      /**
       * @typedef {Record<string, any>} Props
       */

      /** @type {Element | null} */
      let parentElement = null;

      /**
       * @param {Element} elt
       * @param {Props} props
       */
      const setProps = (elt, props) => {
        for (const key in props) {
          const value = props[key];
          if (value == null) {
            continue;
          }
          if (key.startsWith("on")) {
            const eventName = key.slice(2).toLocaleLowerCase();
            elt.addEventListener(eventName, value);
          } else if (key in elt) {
            elt[key] = typeof value === "function" ? value() : value;
          } else {
            elt.setAttribute(
              key,
              String(value === "function" ? value() : value)
            );
          }
        }
      };

      /**
       * @type {{
       *   [TagName in keyof HTMLElementTagNameMap]: Modify<HTMLElementTagNameMap[TagName]>;
       * }}
       */
      const html = new Proxy(Object.create(null), {
        set(_target, tagName, modify) {
          const parent = parentElement;
          const elt = document.createElement(tagName);
          const props = modify.length ? Object.create(null) : undefined;
          parentElement = elt;
          modify(props);
          parentElement = parent;
          createEffect(() => setProps(elt, props));
          parent?.appendChild(elt);
          return true;
        },
      });

      /**
       * @param {Element} rootElement
       * @param {() => void} modify
       * @returns {() => void}
       */
      const render = (rootElement, modify) => {
        return createScope((dispose) => {
          const previousParentElement = parentElement;
          parentElement = rootElement;
          modify();
          parentElement = previousParentElement;
          return dispose;
        });
      };

      const stopEffects = render(document.body, () => {
        const counter = createSignal(0);
        let id;
        onMount(() => {
          id = setInterval(() => {
            counter(counter() + 1);
          }, 1000);
        });
        onCleanup(() => clearInterval(id));

        html.h1 = (props) => {
          props.textContent = "signal/elements";
        };

        html.main = () => {
          html.div = (props) => {
            props.textContent = counter;
          };

          html.button = (props) => {
            props.textContent = "Stop Effects";
            props.onClick = () => stopEffects();
          };
        };
      });
    </script>
  </head>
  <body></body>
</html>
