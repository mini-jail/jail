<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>signal/elements</title>
    <script type="importmap">
      {
        "imports": {
          "signal": "https://cdn.jsdelivr.net/gh/mini-jail/signal/packages/signal/mod.js"
        }
      }
    </script>
    <script type="module">
      import {
        createSignal,
        createScope,
        createEffect,
        onCleanup,
        onMount,
      } from "signal";

      /** @type {Element | null} */
      let parentElement = null;

      /**
       * @template T
       * @param {T & keyof HTMLElementTagNameMap} tagName
       * @param {(elt: HTMLElementTagNameMap[T]) => void} [modify]
       * @returns {HTMLElementTagNameMap[T]}
       */
      const createElement = (tagName, modify) => {
        const parent = parentElement;
        const elt = document.createElement(tagName);
        if (modify) {
          parentElement = elt;
          modify(modify.length ? elt : undefined);
          parentElement = parent;
        }
        parent?.appendChild(elt);
        return elt;
      };

      /**
       * @template T
       * @param {T & Element} rootElement
       * @param {(elt: T) => void} modify
       * @returns {() => void}
       */
      const render = (rootElement, modify) => {
        return createScope((dispose) => {
          const previousParentElement = parentElement;
          parentElement = rootElement;
          modify(parentElement);
          parentElement = previousParentElement;
          return dispose;
        });
      };

      const App = () => {
        const counter = createSignal(0);
        let id;
        onMount(() => {
          id = setInterval(() => {
            counter(counter() + 1);
          }, 1000);
        });
        onCleanup(() => clearInterval(id));

        createElement("h1", (elt) => {
          elt.textContent = "signal/elements";
        });
        createElement("main", () => {
          createElement("div", (elt) => {
            createEffect(() => {
              elt.textContent = String(counter());
            });
          });
          createElement("button", (elt) => {
            elt.textContent = "Stop Effects";
            elt.onclick = () => stopEffects();
          });
        });
      };

      const stopEffects = render(document.body, () => {
        App();
      });
    </script>
  </head>
  <body></body>
</html>
